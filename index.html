<html>
<head>

<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<style> 
    circle {
        stroke: black;
    } 

    .tooltip {
        position: fixed;
        display: inline-block;
        border-color: black transparent transparent transparent;
    }

    ul {
        margin: 0;
        padding: 0;
        list-style-type: none;
        overflow-y: hidden;
        white-space: nowrap;
    }

    li+li {
        padding: 1em 2em 1em 3em;
    }

    li {
        padding: 1em 2em;
        position: relative;
        display: inline-block;
        vertical-align: top;
    }

    li.active,
    li.active+li:before {
        background: lightgreen;
    }

    li:hover:before,
    li.active:before {
        background: white;
    }

    li:last-child:after,
    li+li:before {
        content: '';
        position: absolute;
        top: -0.1em;
        bottom: 0;
        border-right: solid;
        border-top: solid;
        pointer-events: none;
        box-sizing: border-box;
        box-shadow: 3px -3px 6px -3px gray;
        width: 3em;
        transform: rotate(30deg) skewy(30deg);
        z-index: 1;
    }

    li:last-child:after {
        right: -1.5em;
        background: inherit;
    }

    li+li:before {
        left: -2em;
    }

    a {
        cursor: pointer;
    }
</style>
</head>
<body onload="init()">
<br>
<div align="center">
<ul>
    <li id="OverviewMenu" >
        <a onclick="clearChart();qualityOverview();return false;">Overview</a>
    </li>
    <li id="WellboresMenu">
        <a onclick="if(isWellbores) {clearChart();qualityWeekly(currentDate);} else {return false;}">Wellbores</a>
    </li>
    <li id="DimensionMenu">
        <a>Dimensions</a>
    </li>
</ul>
</div>

<div id="tooltip_div"></div>    
<p>
    <svg id="the_chart_svg" width="800" height="500" style="display: block;margin: auto"></svg>
    <svg id="the_legend_svg" width="800" height="100" style="display: block;margin: auto"></svg>
</p>
<p id="the_text"></p>
<script>
    var currentDate = "";
    var currentWellbore = "";

    var isOverview = true;
    var isWellbores = false;
    var isDimensions = false;
    var isDimensions = false;

    const lowThreshold = 50;
    const mediumThreshold = 80;
    const lowTag = "Low";
    const mediumTag = "Medium";
    const highTag = "High";

    const tagColor = {
        "Low": "red",
        "Medium": "orange",
        "High": "green"
    };
    
    function qualityTag(score) {
        if (score <= lowThreshold) {
            return lowTag;
        } else if (score > lowThreshold && score <= mediumThreshold) {
            return mediumTag;  
        } else {
            return highTag;
        }
    }

    function qualityOverview () {
        d3.csv("overview_quality.csv")
        .then(function(data) {
            overviewText();
            
            isOverview = true;
            isWellbores = false;
            isDimensions = false;
            isDimensions = false;

            d3.select("#OverviewMenu").attr("class", "active");
            d3.select("#WellboresMenu").attr("class", "");
            d3.select("#DimensionMenu").attr("class", "");
            

            var svg = d3.select("#the_chart_svg");
            translateX = 50;
            translateY = 50;
            width = svg.attr("width") - (2 * translateX);
            height = svg.attr("height") - (2 * translateY);

            // x value
            const parseDate = d3.timeParse("%d-%b-%y");

            const x = d3.scaleTime()
                    .domain(d3.extent(data, (date) => parseDate(date.Date)))
                    .range([0,width]);
            const y = d3.scaleLinear()
                    .domain([30,100])
                    .range([height,0]);

            // Add the lines
            var div = d3.select("#tooltip_div")
                .attr('class', 'tooltip')
                .style('opacity', 0);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d) { return x(parseDate(d.Date)); })
                    .y(function(d) { return y(d.TotalQualityScore); })
                );

            // Add the scatter-points
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function(d) { return x(parseDate(d.Date)); }  )
                .attr("cy", function(d) { return y(d.TotalQualityScore); } )
                .attr("r", 8)
                .style("fill", 
                    function(d) {
                        return tagColor[qualityTag(d.TotalQualityScore)];
                    }
                )
                .style('cursor', 'pointer')
                .on('mouseover', 
                    function(d) {
                        div
                            .transition()
                            .duration(10)
                            .style('opacity', 0.9);
                        div
                            .html("Date: " + d.Date + "<br/> Score: " + d.TotalQualityScore)
                            .style("left", (d3.event.pageX-50) + "px")
                            .style("top", (d3.event.pageY-55) + "px");
                    }
                )
                .on('mouseout', 
                    () => { div.style('opacity', 0); }
                )
                .on("click", function(d) {
                    div.style('opacity', 0);
                    clearChart();
                    qualityWeekly(d.Date);
                    currentDate = d.Date;

                    isOverview = true;
                    isWellbores = true;
                    isDimensions = false;
                    isDimensions = false;
                });

            // Add y-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(d3.axisLeft(y));

            // Add x-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+(height+translateY)+")")
                .call(d3.axisBottom(x));

            // Add X axis label
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("text")
                .attr("text-anchor", "end")
                .attr("x", (width / 2) + 80)
                .attr("y", height + 40)
                .text("Evaluation Date");
            // Y axis label
            svg.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", 15)
                .attr("x", -height/2)
                .text("Quality Score")

            // Add low threshold
            var path = d3.path();
            path.moveTo(0, y(lowThreshold));
            path.lineTo(width, y(lowThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "red");

            // Add medium threshold
            path = d3.path();
            path.moveTo(0, y(mediumThreshold));
            path.lineTo(width, y(mediumThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "orange");

            // Add low quality threshold annotation
            var annotations = [
                {
                    note: {
                        label: "Low Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },    
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(lowThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["red"]
                }
            ];

            var makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);


            // Add medium quality threshold annotation
            annotations = [
                {
                    note: {
                        label: "Medium Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(mediumThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["orange"]
                }
            ];

            makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);

            // Add chart title
            svg.append("text")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .attr("x", 15 + (width / 2))             
                .attr("y", -15)
                .attr("text-anchor", "middle")  
                .style("font-size", "28px") 
                .text("Data-Quality Score Overview");

            // Add legend
            var svg = d3.select("#the_legend_svg");

            svg.append("text").attr("x",5).attr("y",20).text("Legend: ").style("font-size", "16px").style("text-decoration", "underline");
            svg.append("circle").attr("cx",10).attr("cy",40).attr("r", 6).style("fill", "green");
            svg.append("circle").attr("cx",10).attr("cy",60).attr("r", 6).style("fill", "orange");
            svg.append("circle").attr("cx",10).attr("cy",80).attr("r", 6).style("fill", "red");
            svg.append("text").attr("x",20).attr("y",40).text("High Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",60).text("Medium Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",80).text("Low Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
        })
        .catch(function(error){
            // handle error
        })
    }

    function qualityWeekly (Date) {
        d3.csv("wellbore_quality.csv")
        .then(function(data) {
            wellboresText ();

            d3.select("#OverviewMenu").attr("class", "active");
            d3.select("#WellboresMenu").attr("class", "active");
            d3.select("#DimensionMenu").attr("class", "");

            data = data.filter(function (el) {
                return (el.Date == Date);
            });

            var svg = d3.select("#the_chart_svg");
            translateX = 50;
            translateY = 50;
            width = svg.attr("width") - (2 * translateX);
            height = svg.attr("height") - (2 * translateY);

            // x value
            const parseDate = d3.timeParse("%d-%b-%y");

            var wellbores = [];
            for(var i=0; i<data.length; i++){
                wellbores.push(data[i].Wellbore);
            }

            const x = d3.scaleBand()
                    .domain(wellbores)
                    .range([0,width]).padding(0.25);
            const y = d3.scaleLinear()
                    .domain([30,100])
                    .range([height,0]);

            // Add the barchart   
            const bar_width = 100;
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                .style("fill", 
                    function(d) {
                        return tagColor[qualityTag(d.TotalQualityScore)];
                    }
                )
                .attr("x", function(d,i) {return x(d.Wellbore);})
                .attr("y", function(d,i) {return y(d.TotalQualityScore);})
                .attr("width", bar_width)
                .attr("height", function(d,i) {return height-y(d.TotalQualityScore);})
                .style('cursor', 'pointer')
                .on("click", function(d) {
                    clearChart();
                    qualityWellbore(d.Wellbore, d.Date);
                    currentWellbore = d.Wellbore;

                    isOverview = true;
                    isWellbores = true;
                    isDimensions = true;
                    isDimensions = false;
                });

            // Add y-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(d3.axisLeft(y));

            // Add x-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+(height+translateY)+")")
                .call(d3.axisBottom(x));

            // Add X axis label
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("text")
                .attr("text-anchor", "end")
                .attr("x", (width / 2) + 80)
                .attr("y", height + 40)
                .text("Wellbore");
            // Y axis label
            svg.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", 15)
                .attr("x", -height/2)
                .text("Quality Score")

            // Add low threshold
            var path = d3.path();
            path.moveTo(0, y(lowThreshold));
            path.lineTo(width, y(lowThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "red");

            // Add medium threshold
            path = d3.path();
            path.moveTo(0, y(mediumThreshold));
            path.lineTo(width, y(mediumThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "orange");

            // Add chart title
            svg.append("text")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .attr("x", 15 + (width / 2))             
                .attr("y", -15)
                .attr("text-anchor", "middle")  
                .style("font-size", "28px")  
                .text("Wellbore Data-Quality Score on " + currentDate);

            // Add legend
            var svg = d3.select("#the_legend_svg");

            svg.append("text").attr("x",5).attr("y",20).text("Legend: ").style("font-size", "16px").style("text-decoration", "underline");
            svg.append("rect").attr("x",4).attr("y",30).attr("width", 14).attr("height", 14).style("fill", "green").style("stroke", "black");;
            svg.append("rect").attr("x",4).attr("y",50).attr("width", 14).attr("height", 14).style("fill", "orange").style("stroke", "black");;
            svg.append("rect").attr("x",4).attr("y",70).attr("width", 14).attr("height", 14).style("fill", "red").style("stroke", "black");;
            svg.append("text").attr("x",20).attr("y",40).text("High Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",60).text("Medium Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",80).text("Low Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
        })
        .catch(function(error){
            // handle error
        })
    }    

    function qualityWellbore (Wellbore, Date) {
        d3.csv("wellbore_quality.csv")
        .then(function(data) {
            dimensionText();

            d3.select("#OverviewMenu").attr("class", "active");
            d3.select("#WellboresMenu").attr("class", "active");
            d3.select("#DimensionMenu").attr("class", "active");

            data = data.filter(function (el) {
                return (el.Wellbore == Wellbore && el.Date == Date);
            });

            var svg = d3.select("#the_chart_svg");
            translateX = 50;
            translateY = 50;
            width = svg.attr("width") - (2 * translateX);
            height = svg.attr("height") - (2 * translateY);

            // x value
            const parseDate = d3.timeParse("%d-%b-%y");

            console.log(data);
            var dimensions = [];
            dimensions.push({
                "dimension": "Validity",
                "score": data[0].ValidityScore
            });
            dimensions.push({
                "dimension": "Completeness",
                "score": data[0].CompletenessScore
            });
            dimensions.push({
                "dimension": "Consistency",
                "score": data[0].ConsistencyScore
            });

            const x = d3.scaleBand()
                    .domain(["Validity", "Completeness", "Consistency"])
                    .range([0,width]).padding(0.5);
            const y = d3.scaleLinear()
                    .domain([0,100])
                    .range([height,0]);

            // Add the barchart   
            const bar_width = 100;
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .selectAll("rect")
                .data(dimensions)
                .enter()
                .append("rect")
                .style("fill", 
                    function(d) {
                        return tagColor[qualityTag(d.score)];
                    }
                )
                .attr("x", function(d,i) {return x(d.dimension);})
                .attr("y", function(d,i) {return y(d.score);})
                .attr("width", bar_width)
                .attr("height", function(d,i) {return height-y(d.score);});

            // Add y-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(d3.axisLeft(y));

            // Add x-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+(height+translateY)+")")
                .call(d3.axisBottom(x));

            // Add X axis label
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("text")
                .attr("text-anchor", "end")
                .attr("x", (width / 2) + 80)
                .attr("y", height + 40)
                .text("Dimension");
            // Y axis label
            svg.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", 15)
                .attr("x", -height/2)
                .text("Quality Score")

            // Add low threshold
            var path = d3.path();
            path.moveTo(0, y(lowThreshold));
            path.lineTo(width, y(lowThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "red");

            // Add medium threshold
            path = d3.path();
            path.moveTo(0, y(mediumThreshold));
            path.lineTo(width, y(mediumThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "orange");

            // Add chart title
            svg.append("text")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .attr("x", 15 + (width / 2))             
                .attr("y", -15)
                .attr("text-anchor", "middle")  
                .style("font-size", "28px") 
                .text("Dimension Scores of " + currentWellbore);

            // Add legend
            var svg = d3.select("#the_legend_svg");

            svg.append("text").attr("x",5).attr("y",20).text("Legend: ").style("font-size", "16px").style("text-decoration", "underline");
            svg.append("rect").attr("x",4).attr("y",30).attr("width", 14).attr("height", 14).style("fill", "green").style("stroke", "black");
            svg.append("rect").attr("x",4).attr("y",50).attr("width", 14).attr("height", 14).style("fill", "orange").style("stroke", "black");
            svg.append("rect").attr("x",4).attr("y",70).attr("width", 14).attr("height", 14).style("fill", "red").style("stroke", "black");
            svg.append("text").attr("x",20).attr("y",40).text("High Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",60).text("Medium Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",80).text("Low Quality Data").style("font-size", "14px").attr("alignment-baseline","middle");
        })
        .catch(function(error){
            // handle error
        })
    }    

    function clearChart() {
        d3.select("#the_chart_svg").selectAll("*").remove();
        d3.select("#the_legend_svg").selectAll("*").remove();
        d3.select("#tooltip_div").selectAll("*").remove();
        d3.select("body").style('cursor', 'default');
    }

    async function init() {
        qualityOverview();
    }

    function overviewText() {
        d3.select("#the_text").text(`
            The sun slowly set over the tranquil lake, casting a warm orange glow across 
            the water. A gentle breeze rustled through the trees, creating a soothing melody. 
            Birds chirped in the distance, their songs blending with the sounds of nature. 
            As the evening descended, the air grew cooler, and a blanket of stars emerged in 
            the darkening sky. The stillness of the moment was interrupted by the distant 
            howl of a lone wolf, adding a touch of wildness to the serene scene. 
            It was a moment of perfect harmony between the beauty of nature and the peace 
            within.
        `);
    }

    function wellboresText() {
        d3.select("#the_text").text(`
            The bustling city streets were alive with a vibrant energy as people hurriedly 
            went about their day. Tall skyscrapers reached towards the heavens, their glass 
            facades reflecting the sunlight. Honking horns and the occasional siren added to 
            the symphony of urban sounds. Sidewalk cafes overflowed with laughter and 
            conversations, while the aroma of freshly brewed coffee wafted through the air. 
            Amidst the chaos, street artists painted colorful masterpieces on the walls, 
            adding splashes of creativity to the concrete jungle. It was a constant dance 
            of movement and diversity, where dreams intertwined with the pulse of the 
            metropolis.`);
    }

    function dimensionText() {
        d3.select("#the_text").text(`
            The crisp autumn air embraced the countryside, as leaves of gold and red 
            danced upon the gentle breeze. The scent of bonfires and apple orchards 
            permeated the surroundings, invoking a sense of nostalgia. Harvesters toiled 
            in the fields, their hard work rewarded by bountiful crops. The distant sound 
            of laughter echoed from a nearby pumpkin patch, where families gathered to 
            choose their perfect Halloween adornments. Sunflowers stood tall, their 
            vibrant petals reaching for the sky. As daylight waned, a blanket of stars 
            emerged, painting the night sky with twinkling constellations. It was a season 
            of warmth, abundance, and enchantment.`);
    }
</script>
</body>
</html>