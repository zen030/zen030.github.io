<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<style> 
    circle {stroke: black;} 
</style>
<body onload='init()'>

<svg width=500 height=500></svg>

<script>
    const lowThreshold = 50;
    const mediumThreshold = 80;
    const lowTag = "Low";
    const mediumTag = "Medium";
    const highTag = "High";

    const tagColor = {
        "Low": "red",
        "Medium": "orange",
        "High": "green"
    }

    function qualityTag(score) {
        if (score <= lowThreshold) {
            return lowTag;
        } else if (score > lowThreshold && score <= mediumThreshold) {
            return mediumTag;  
        } else {
            return highTag;
        }
    }

    function qualityOverview () {
        d3.csv("overview_quality.csv")
        .then(function(data) {

            var svg = d3.select("svg");
            translateX = 50;
            translateY = 50;
            width = svg.attr("width") - (2 * translateX);
            height = svg.attr("height") - (2 * translateY);

            console.log(data[0].Date);

            // x value
            const parseDate = d3.timeParse("%d-%b-%y");

            console.log(parseDate(data[0].Date));

            const x = d3.scaleTime()
                    .domain(d3.extent(data, (date) => parseDate(date.Date)))
                    .range([0,width]);
            const y = d3.scaleLinear()
                    .domain([30,100])
                    .range([height,0]);

            // Add the lines
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d) { return x(parseDate(d.Date)); })
                    .y(function(d) { return y(d.TotalQualityScore); })
                );

            // Add the scatter-points
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function(d) { return x(parseDate(d.Date)); }  )
                .attr("cy", function(d) { return y(d.TotalQualityScore); } )
                .attr("r", 4)
                .style("fill", 
                    function(d) {
                        return tagColor[qualityTag(d.TotalQualityScore)];
                    }
                );

            // Add y-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(d3.axisLeft(y));

            // Add x-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+(height+translateY)+")")
                .call(d3.axisBottom(x));

            // Add low threshold
            var path = d3.path();
            path.moveTo(0, y(lowThreshold));
            path.lineTo(width, y(lowThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "red");

            // Add medium threshold
            path = d3.path();
            path.moveTo(0, y(mediumThreshold));
            path.lineTo(width, y(mediumThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "orange");

            // Add low quality threshold annotation
            var annotations = [
                {
                    note: {
                        label: "Low Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },    
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(lowThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["red"]
                }
            ];

            var makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);


            // Add medium quality threshold annotation
            annotations = [
                {
                    note: {
                        label: "Medium Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(mediumThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["orange"]
                }
            ];

            makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);
        })
        .catch(function(error){
            // handle error
        })
    }

    async function init() {
        qualityOverview();
    }
</script>

</body>
</html>

