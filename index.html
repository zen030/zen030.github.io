<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<style> 
    circle {stroke: black;} 
    .svg,
    .text {
        vertical-align: top;
        display: inline-block;
    }
    .column {
        float: left;
        width: 50%;
    }

    .row:after {
        content: "";
        display: table;
        clear: both;
    }
</style>
<body onload='init()'>

    <div class="row">
    <div class="column">
    <p><svg id="overview_chart" width=700 height=700></svg>
        <br>
        <svg id="overview_legend" width=400 height=100></svg></p>
    </div>
    <div class="column">
    <h2>Wellbore Data Quality</h2>
    <p>
        Lorem Ipsum is simply dummy text of the printing and typesetting industry. 
        Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, 
        when an unknown printer took a galley of type and scrambled it to make a type specimen book. 
        It has survived not only five centuries, but also the leap into electronic typesetting, 
        remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset 
        sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like 
        Aldus PageMaker including versions of Lorem Ipsum.</p>
    </div>
</div>


<script>
    const lowThreshold = 50;
    const mediumThreshold = 80;
    const lowTag = "Low";
    const mediumTag = "Medium";
    const highTag = "High";

    const tagColor = {
        "Low": "red",
        "Medium": "orange",
        "High": "green"
    }

    function qualityTag(score) {
        if (score <= lowThreshold) {
            return lowTag;
        } else if (score > lowThreshold && score <= mediumThreshold) {
            return mediumTag;  
        } else {
            return highTag;
        }
    }

    function qualityOverview () {
        d3.csv("overview_quality.csv")
        .then(function(data) {

            var svg = d3.select("#overview_chart");
            translateX = 50;
            translateY = 50;
            width = svg.attr("width") - (2 * translateX);
            height = svg.attr("height") - (2 * translateY);

            console.log(data[0].Date);

            // x value
            const parseDate = d3.timeParse("%d-%b-%y");

            console.log(parseDate(data[0].Date));

            const x = d3.scaleTime()
                    .domain(d3.extent(data, (date) => parseDate(date.Date)))
                    .range([0,width]);
            const y = d3.scaleLinear()
                    .domain([30,100])
                    .range([height,0]);

            // Add the lines
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d) { return x(parseDate(d.Date)); })
                    .y(function(d) { return y(d.TotalQualityScore); })
                );

            // Add the scatter-points
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", function(d) { return x(parseDate(d.Date)); }  )
                .attr("cy", function(d) { return y(d.TotalQualityScore); } )
                .attr("r", 8)
                .style("fill", 
                    function(d) {
                        return tagColor[qualityTag(d.TotalQualityScore)];
                    }
                );

            // Add y-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(d3.axisLeft(y));

            // Add x-axis
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+(height+translateY)+")")
                .call(d3.axisBottom(x));

            // Add X axis label
            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("text")
                .attr("text-anchor", "end")
                .attr("x", (width / 2) + 80)
                .attr("y", height + 40)
                .text("Evaluation Date");
            // Y axis label
            svg.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", 15)
                .attr("x", -height/2)
                .text("Quality Score")

            // Add low threshold
            var path = d3.path();
            path.moveTo(0, y(lowThreshold));
            path.lineTo(width, y(lowThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "red");

            // Add medium threshold
            path = d3.path();
            path.moveTo(0, y(mediumThreshold));
            path.lineTo(width, y(mediumThreshold));

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .append("path")
                .attr("d", path)
                .attr("stroke", "orange");

            // Add low quality threshold annotation
            var annotations = [
                {
                    note: {
                        label: "Low Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },    
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(lowThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["red"]
                }
            ];

            var makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);


            // Add medium quality threshold annotation
            annotations = [
                {
                    note: {
                        label: "Medium Quality Threshold Line",
                        align: "middle",
                        wrap: 100,
                        padding: 5
                    },
                    connector: {
                        end: "arrow",
                        type: "line"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                        radius: 10, 
                        radiusPadding: 0
                    },
                    x: width-20,
                    y: y(mediumThreshold),
                    dx: -10,
                    dy: 40,
                    color: ["orange"]
                }
            ];

            makeAnnotations = d3.annotation().annotations(annotations);

            svg
                .append("g")
                .attr("transform", "translate("+translateX+","+translateY+")")
                .call(makeAnnotations);

            // Add chart title
            svg.append("text")
                .attr("x", (width / 2) + 40)             
                .attr("y", 20)
                .attr("text-anchor", "middle")  
                .style("font-size", "20px") 
                .style("text-decoration", "underline")  
                .text("Wellbore Data Quality Score Overview");

            // Add legend
            var svg = d3.select("#overview_legend");

            svg.append("text").attr("x",5).attr("y",20).text("Legend: ").style("font-size", "18px").style("text-decoration", "underline");
            svg.append("circle").attr("cx",10).attr("cy",40).attr("r", 6).style("fill", "green");
            svg.append("circle").attr("cx",10).attr("cy",60).attr("r", 6).style("fill", "orange");
            svg.append("circle").attr("cx",10).attr("cy",80).attr("r", 6).style("fill", "red");
            svg.append("text").attr("x",20).attr("y",40).text("High Quality Data").style("font-size", "15px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",60).text("Medium Quality Data").style("font-size", "15px").attr("alignment-baseline","middle");
            svg.append("text").attr("x",20).attr("y",80).text("Low Quality Data").style("font-size", "15px").attr("alignment-baseline","middle");
        })
        .catch(function(error){
            // handle error
        })
    }

    async function init() {
        qualityOverview();
    }
</script>

</body>
</html>

